let features="",rects=[],balls=[],bgTextureDone=!1,rectDrawn=!1,margin=0,format={portrait:[1500,2e3],landscape:[2e3,1500],square:[1500,1500]},angles={straight:[0,90],diagonal:[45,135],straight_0:[0],straight_90:[90],diagonal_45:[45],diagonal_135:[135],random:[0,90,180,270,45,135,225,315]};function setup(){console.log($fx.getFeatures()),features=$fx.getFeatures();let e=features.format_mode;var t=window.navigator.userAgent,r=!!t.match(/iPad/i)||!!t.match(/iPhone/i),o=!!t.match(/WebKit/i);r&&o&&!t.match(/CriOS/i)?pixelDensity(1):pixelDensity(3),createCanvas(format[e][0],format[e][1]),colorMode(HSB,360,100,100,100),randomSeed(1e4*fxrand()),noiseSeed(1e4*fxrand()),rectMode(CENTER),margin=(width+height)/random([25,40,50,60,80]);let l=random([0,10,20,30,40,50]),a=10,n="light"===features.bg_mode?100:10,c=color(l,a,n);background(c);let s=angles[features.angle_mode],i={"80s":[color(44,96,100),color(19,97,98),color(334,100,100),color(265,76,93),color(217,77,100)],"90s":[color(333,85,97),color(276,95,72),color(258,93,64),color(229,72,93),color(194,68,88)],june:[color(199,56,90),color(192,82,74),color(200,97,48),color(43,99,100),color(32,100,98)],mango:[color(196,69,92),color(340,80,92),color(146,66,91),color(29,98,92),color(45,100,90)],traditional:[color(223,80,75),color(145,100,60),color(43,88,85),color(16,81,85),color(1,96,85),color(334,75,75)],mono:[color(l,a,10),color(l,a,90)]};"mono"===features.palette_mode&&"light"===features.bg_mode?i.mono=[color(l,a,10)]:"mono"===features.palette_mode&&"dark"===features.bg_mode&&(i.mono=[color(l,a,90)]);let d=i[features.palette_mode],g=features.ellipse_num+features.rectangle_num;"border"===features.border_mode&&(strokeWeight(margin),stroke(l,a,"light"==features.bg_mode?10:100),noFill(),rect(width/2,height/2,width-margin,height-margin)),createTexture(c),checkTexturesAndDrawShapes(features,d,s,c,l,g)}function checkTexturesAndDrawShapes(e,t,r,o,l,a){const n=setInterval((()=>{if(bgTextureDone&&(clearInterval(n),e.shape_type.includes("line")||e.shape_type.includes("rectangle")?createRectangles(margin,t,r,o,e.shape_type,e.line_num,e.rectangle_num,a):rectDrawn=!0,e.shape_type.includes("ellipse"))){const e=setInterval((()=>{rectDrawn&&(createBalls(margin,t,o,rects,a),clearInterval(e))}),100)}}),100),c=setInterval((()=>{if(bgTextureDone){let e=Array.from({length:rects.length},(()=>!1)),t=Array.from({length:balls.length},(()=>!1));for(let t=0;t<rects.length;t++)e[t]=rects[t].isTextureDone();for(let e=0;e<balls.length;e++)t[e]=balls[e].isTextureDone();const r=e.filter((e=>!0===e)).length,o=t.filter((e=>!0===e)).length;0===rects.length?rectTextureDone=!0:rectTextureDone=r===rects.length,0===balls.length?ballTextureDone=!0:ballTextureDone=o===balls.length,rectTextureDone&&ballTextureDone&&(console.log("done"),fxpreview(),clearInterval(c))}}),200)}function createBalls(e,t,r,o,l){const a=features.ellipse_num;for(let n=0;n<a;n++){let c=1,s=new Ball(e,t,r,a,l,n+1,0),i=!0;do{i=balls.some((e=>collideCircleCircle(s.x,s.y,s.d,e.x,e.y,e.d,!0)))||o.some((e=>collideCirclePoly(s.x,s.y,s.d,e.points,!0))),i&&(s=new Ball(e,t,r,a,l,n+1,++c))}while(i);balls.push(s),s.draw()}}function createRectangles(e,t,r,o,l,a=0,n=0,c){const s=a+n;for(let l=0;l<s;l++){const a=l<n?"rectangle":"line";let s=new Rect(e,t,r,o,a,n,c,l+1,0),i=0;for(;rects.some(((e,t)=>l!==t&&collidePolyPoly(s.points,e.points,!0)));)s=i>1e3?new Rect(e,t,r,o,a,n,c,l+1,i,0,0):new Rect(e,t,r,o,a,n,c,l+1,i),i++;rects.push(s),s.draw()}rectDrawn=!0}function createTexture(e){let t=[];for(let r=0;r<5;r++){const o=random(0,width),l=random(0,height),a=random(width/8,width/2);t[r]=new Smudge(o,l,a,e)}let r=drawTexture(t),o=setInterval((()=>{r.next().done&&(bgTextureDone=!0,clearInterval(o))}),0)}function*drawTexture(e){let t=0;for(let r=0;r<e.length;r++)for(let o=0;o<3e5;o++)e[r].display(),t++,t>2e3&&(t=0,yield)}paletteObj="",rectTextureDone=!1,ballTextureDone=!1;